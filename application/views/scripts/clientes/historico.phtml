<?php $hst = new Historico(); ?>
<div id="conteudoCanvas">

    <div id="canvasHeader">
        <div id="headerImagem" class="imgEmpresa"></div>

        <h1><?php echo $this->cliente->nome; ?></h1>

        <ul class="listaInfo">
            <li><span>Categoria:</span> <?php echo ($this->cliente->id_categoria == null ? 'Não definido' : $this->cliente->findParentRow('Categoria')->nome); ?></li>
            <li><span>Telefone:</span> <?php echo ($this->cliente->telefone == null ? 'Não definido' : $this->cliente->telefone); ?></li>
        </ul>

        <ul id="headerSubMenu">
            <li><span>Ver histórico</span></li>
            <li class="spacer">|</li>
            <li><a href="/clientes/pessoas/id/<?php echo $this->cliente->id; ?>" title="Ver pessoas deste Cliente">Ver pessoas</a></li>
            <li class="spacer">|</li>
            <li><a href="/clientes/editar/id/<?php echo $this->cliente->id; ?>" title="Editar este Cliente">Editar</a></li>
            <li class="spacer">|</li>
            <li><a href="/clientes/remover/id/<?php echo $this->cliente->id; ?>" title="Excluir este Cliente">Excluir</a></li>
        </ul><!--headerSubMenu-->

        <div class="clear"></div>

    </div><!--canvasHeader-->

    <form action="/clientes/grava-historico" id="formComentar" method="post" enctype="multipart/form-data">
        <input type="hidden" name="id_cliente" value="<?php echo $this->cliente->id; ?>" />
        <input type="hidden" name="id_usuario" value="<?php echo $this->idUsuario; ?>" />
        <fieldset>
            <label for="formComentario">O que foi feito e qual o próximo passo?</label>
            <textarea name="texto" id="formComentario"></textarea>
        </fieldset>

        <fieldset id="setDtAgenDocsImgs">

            <div id="setDtAgen" style="display: none;">
                <a href="javascript:void(0)" class="btnFechar" id="btnFechar" title="Cancelar agendamento"></a>
                <label>Tarefa para quando?</label>
                <input type="text" name="dtAgendamento" id="formDtAgendamento" class="text focus hasDatepicker">às <input type="text" name="horaAgendamento" id="formHoraAgendamento" class="text w80" value="" autocomplete="off">

                <label>A quem se destina?</label>

                <ul class="ulSelUsuarios">
                    <li>
                        <label>
                            <input type="checkbox" name="usuario[]" value="me" class="checkbox" checked="checked"> A mim<em></em>
                        </label>
                    </li>
                </ul><!--ulSelUsuarios-->

                <div class="clear"></div>

            </div><!--setDtAgen-->

            <div id="setDocsImgs" style="display: none;">
                <ul>
                    <li class="liImg">
                        <input class="file" title="" name="arquivo[]" type="file">
                        <a href="javascript:void(0);" class="btnExcluir">
                            <img src="/img/icone-btn-fechar-cinza.gif" alt="Excluir">
                        </a>
                    </li>
                    <li>
                        <a href="javascript:void(0);" id="lnkAdicionarNovoArquivo">adicionar um arquivo</a>
                    </li>
                </ul>
            </div><!--setDocsImgs-->
        </fieldset>

        <input type="submit" value="Gravar comentário" class="btn btn-info btn-mini pull-right" id="btnComentar">

        <a href="javascript:void(0);" id="lnkAdicionarArquivosImagens" title="Adicionar arquivos">Adicionar arquivos</a> ou,
        <a href="javascript:void(0);" id="lnkDefinirAgendamento" title="definir agendamento">definir agendamento</a>

        <div class="clear"></div>
    </form>

    <ul class="canvasListagem" id="listComentarios">

        <?php foreach ($this->cliente->findDependentRowset('Historico', null, $hst->select()->order('id desc')) as $historico) : ?>
            <li class="item pb10 comentsPg0">
                <span class="imgAvatar imgUsuario"></span><strong><?php echo $historico->findParentRow('Usuario')->nome; ?></strong>

                <p><?php echo $historico->texto; ?></p>

                <span class="bottom c999">
                    <span rel="tooltip" class="data ml20"><?php echo date("d/m/Y", strtotime($historico->quando)); ?> às <?php echo date("H:i:s", strtotime($historico->quando)); ?></span>
                </span>

                <ul class="menu">
                    <li><a href="" class="lnkEditarComentario cboxElement">Editar</a></li>
                    <li class="spacer">|</li>
                    <li><a href="/clientes/remove-historico/id/<?php echo $historico->id; ?>" class="lnkExcluirComentario" title="Excluir este comentário">Excluir</a></li>
                </ul>

                <div class="clear"></div>
            </li>

        <?php endforeach; ?>
    </ul>
</div>

<script type="text/javascript">
    $('#formComentar').validate({
        rules: {
            texto: {required: true, minLenght: 3}
        }
    });

    var getHtmlNovaImagem = function() {
        return '<li class="liImg">' +
                '<input class="file" title="" name="arquivo[]" type="file">' +
                '<a href="javascript:void(0);" class="btnExcluir">' +
                '<img src="/img/icone-btn-fechar-cinza.gif" alt="Excluir">' +
                '</a></li>';
    };

    $("#setDocsImgs #lnkAdicionarNovoArquivo").click(function() {
        $(this).parent().before(getHtmlNovaImagem());
    });

    $("body").on('click', '.btnExcluir', function() {
        $(this).parent().remove();
    });

    $("#lnkDefinirAgendamento").click(function() {
        if ($("#setDtAgen").is(":visible"))
            cancelarAgendamento();
        else
            mostraAgendamento();
    });

    $("#btnFechar").click(function() {
        cancelarAgendamento();
    });

    $("#lnkAdicionarArquivosImagens").click(function() {
        if ($("#setDocsImgs").is(":visible")) {
            $("#setDocsImgs").slideUp('fast', function() {
                cancelarArquivos();
            });
        } else {
            mostrarArquivos();
        }
    });


    var mostraAgendamento = function() {
        $("#setDtAgen").slideDown('fast');
        $("#lnkDefinirAgendamento").attr('title', 'cancelar agendamento').html("cancelar agendamento");
        $(".ulSelUsuarios").find("li input[type=checkbox]:first").attr('checked', true);
    };

    var cancelarAgendamento = function() {
        $(".ulSelUsuarios").find("li input[type=checkbox]").attr('checked', false);
        $("#setDtAgen").hide();
        $("#setDtAgen").slideUp('fast');
        $("#lnkDefinirAgendamento").attr('title', 'definir agendamento').html("definir agendamento");
    };

    var mostrarArquivos = function() {
        $("#setDocsImgs").slideDown('fast');
        $("#lnkAdicionarArquivosImagens").attr('title', 'Cancelar arquivos').html("Cancelar arquivos");
    };

    var cancelarArquivos = function() {
        $("#setDocsImgs li.liImg, #setDocsImgs li.liDoc").remove();
        $("#lnkAdicionarArquivosImagens").attr('title', 'Adicionar arquivos').html("Adicionar Arquivos");
    };
</script>  